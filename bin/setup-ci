#!/bin/bash

# CI í™˜ê²½ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
# pre-commitê³¼ actë¥¼ ì„¤ì¹˜í•˜ê³  êµ¬ì„±í•©ë‹ˆë‹¤.

set -e

echo "ğŸ”§ CI í™˜ê²½ ì„¤ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤..."

# pre-commit ì„¤ì¹˜ í™•ì¸
if ! command -v pre-commit &> /dev/null; then
    echo "ğŸ“¦ pre-commit ì„¤ì¹˜ ì¤‘..."
    if command -v brew &> /dev/null; then
        brew install pre-commit
    elif command -v pip &> /dev/null; then
        pip install pre-commit
    elif command -v pip3 &> /dev/null; then
        pip3 install pre-commit
    else
        echo "âŒ pre-commit ì„¤ì¹˜ ì‹¤íŒ¨: brew, pip, pip3 ì¤‘ í•˜ë‚˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."
        exit 1
    fi
else
    echo "âœ… pre-commitì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
fi

# act ì„¤ì¹˜ í™•ì¸
if ! command -v act &> /dev/null; then
    echo "ğŸ“¦ act ì„¤ì¹˜ ì¤‘..."
    if command -v brew &> /dev/null; then
        brew install act
    else
        echo "âŒ act ì„¤ì¹˜ ì‹¤íŒ¨: brewê°€ í•„ìš”í•©ë‹ˆë‹¤."
        echo "   ìˆ˜ë™ ì„¤ì¹˜: https://github.com/nektos/act#installation"
        exit 1
    fi
else
    echo "âœ… actê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
fi

# Docker ì‹¤í–‰ í™•ì¸
if ! docker info &> /dev/null; then
    echo "âŒ Dockerê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Docker Desktopì„ ì‹œì‘í•´ì£¼ì„¸ìš”."
    exit 1
else
    echo "âœ… Dockerê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
fi

# pre-commit í›… ì„¤ì¹˜
echo "ğŸ”— pre-commit í›… ì„¤ì¹˜ ì¤‘..."
pre-commit install
pre-commit install --hook-type pre-push

# ìŠ¤í¬ë¦°ìƒ· ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p tmp/screenshots

echo ""
echo "ğŸ‰ CI í™˜ê²½ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
echo ""
echo "ğŸ“‹ ì‚¬ìš©ë²•:"
echo "  - ìˆ˜ë™ CI ì‹¤í–‰: bin/run-ci-tests"
echo "  - Git push ì‹œ ìë™ ì‹¤í–‰ë©ë‹ˆë‹¤"
echo "  - ê²°ê³¼ëŠ” tmp/screenshots/ ì— ì €ì¥ë©ë‹ˆë‹¤"
echo ""
echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰:"
echo "  bin/run-ci-tests"